<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SmartBudget Tracker</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- SheetJS (Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- FileSaver -->
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1976d2">

  <style>
    :root {
      --bg: #f5f5f7;
      --card: #fff;
      --accent-income: #4CAF50;
      --accent-expense: #F44336;
      --muted: #777;
      --gap: 12px;
      font-family: Inter, system-ui, Arial, sans-serif;
    }

    html, body {
      height:100%;
      margin:0;
      background:var(--bg);
      font-family:Inter, Arial;
      -webkit-font-smoothing:antialiased;
    }

    .app {
      max-width:900px;
      margin:0 auto;
      padding:16px;
      padding-bottom:96px;
    }

    header h1 {
      font-size:20px;
      margin:0;
    }

    .card {
      background:var(--card);
      padding:14px;
      margin-bottom:14px;
      border-radius:14px;
      box-shadow:0 2px 8px rgba(0,0,0,0.05);
    }

    .row { display:flex; gap:8px; align-items:center; }
    .grid2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }

    button {
      background:#1976d2;
      border:none;
      color:#fff;
      padding:10px 12px;
      border-radius:10px;
      font-size:14px;
    }

    input, select {
      width:100%;
      padding:8px;
      border:1px solid #e0e0e0;
      border-radius:8px;
    }

    .chip {
      display:inline-block;
      padding:7px 10px;
      background:#eee;
      border-radius:20px;
      margin:3px;
      cursor:pointer;
    }
    .chip.active { background:#1976d2; color:#fff; }

    /* Floating Add Button */
    .fab {
      position:fixed;
      right:22px;
      bottom:95px;
      background:#4CAF50;
      width:60px;
      height:60px;
      border-radius:50%;
      font-size:32px;
      display:flex;
      justify-content:center;
      align-items:center;
      color:white;
      z-index:2000;
      box-shadow:0 4px 12px rgba(0,0,0,0.3);
    }

    /* BOTTOM NAV */
    #bottomNav {
      position:fixed;
      left:0; right:0; bottom:0;
      background:white;
      height:70px;
      display:flex;
      justify-content:space-around;
      border-top:1px solid #ddd;
      z-index:1500;
    }

    #bottomNav button {
      background:none;
      border:none;
      padding:6px;
      color:#666;
      font-size:13px;
      font-weight:600;
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    #bottomNav button.active {
      color:#1976d2;
    }

    /* MOBILE FIX: Prevent right-scroll overflow */
    .table-container {
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      width:100%;
    }

  </style>
</head>

<body>
  <div class="app">
    <header>
      <h1>SmartBudget Tracker</h1>
      <div style="color:#777;font-size:13px;">Track income, expenses, budgets & reports</div>
    </header>

    <!-- ===================== DASHBOARD VIEW ===================== -->
    <div id="dashboardView">
      <!-- PERIOD SELECTOR -->
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div style="font-size:13px;color:#777;">Period</div>
            <button class="periodBtn" data-period="today">Today</button>
            <button class="periodBtn" data-period="week">Last 7d</button>
            <button class="periodBtn" data-period="month">This Month</button>
          </div>


          <div style="text-align:right;">
            <div style="font-size:13px;color:#777;">Net Balance</div>
            <div id="netBalance" style="font-weight:700;font-size:22px;">$0.00</div>
            <div id="periodLabel" style="font-size:13px;color:#777;"></div>
          </div>
        </div>
      </div>

      <!-- INCOME + EXPENSE SUMMARY -->
      <div class="card grid2">
        <div>
          <div style="font-size:13px;color:#777;">Total Income</div>
          <div id="totalIncome" style="font-size:22px;font-weight:700;">$0.00</div>
        </div>
        <div>
          <div style="font-size:13px;color:#777;">Total Expenses</div>
          <div id="totalExpense" style="font-size:22px;font-weight:700;color:#F44336;">$0.00</div>
        </div>
      </div>

      <!-- PIE CHART -->
      <div class="card">
        <canvas id="pieChart" style="width:100%;height:220px;"></canvas>
      </div>

      <!-- BUDGET CARDS -->
      <div id="budgetCards"></div>

      <!-- RECENT TRANSACTIONS -->
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <strong>Recent Transactions</strong>
          <div style="font-size:13px;color:#777;"><span id="txCount">0</span> items</div>
        </div>

        <div id="txList" style="margin-top:12px;"></div>
      </div>
    </div>
    <!-- ===================== REPORTS VIEW ===================== -->
    <div id="reportsView" style="display:none;">
      <div class="card">
        <strong>Generate Report</strong>
        <div style="margin-top:10px;">
          <label>From Date</label>
          <input type="date" id="reportFrom">
        </div>
        <div style="margin-top:10px;">
          <label>To Date</label>
          <input type="date" id="reportTo">
        </div>

        <div style="margin-top:12px;">
          <label>Type</label>
          <select id="reportType">
            <option value="all">All</option>
            <option value="income">Income</option>
            <option value="expense">Expense</option>
          </select>
        </div>

        <div style="margin-top:14px;" class="grid2">
          <button id="btnGenReport">Generate</button>
          <button id="btnExportPDF" style="background:#E53935;">Export PDF</button>
        </div>
        <button id="btnExportExcel" style="width:100%;margin-top:10px;background:#4CAF50;">Export Excel</button>
      </div>

      <!-- REPORT RESULTS -->
      <div id="reportResults" class="card" style="display:none;">
        <div>
          <strong>Summary</strong>
          <div id="reportSummary" style="margin-top:10px;font-size:14px;color:#444;"></div>
        </div>

        <hr style="margin:14px 0;border:0;border-bottom:1px solid #eee;">

        <strong>Transactions</strong>
        <div id="reportList" style="margin-top:14px;"></div>
      </div>
    </div>



    <!-- ===================== SETTINGS VIEW ===================== -->
    <div id="settingsView" style="display:none;">
      <div class="card">
        <strong>Settings</strong>

        <div style="margin-top:16px;">
          <label>Default Dashboard View</label>
          <select id="setDefaultDashboard">
            <option value="today">Today</option>
            <option value="week">Last 7 Days</option>
            <option value="month">This Month</option>
          </select>
        </div>

        <div style="margin-top:16px;">
          <label>Default Reports View</label>
          <select id="setDefaultReport">
            <option value="month">This Month</option>
            <option value="week">Last 7 Days</option>
            <option value="today">Today</option>
          </select>
        </div>

        <div style="margin-top:16px;">
          <label>Currency</label>
          <select id="setCurrency">
            <option value="AED">AED</option>
            <option value="USD">USD</option>
            <option value="INR">INR</option>
            <option value="PKR">PKR</option>
            <option value="NPR">NPR</option>
          </select>
        </div>

        <div style="margin-top:16px;">
          <label>Theme Mode</label>
          <select id="setTheme">
            <option value="light">Light</option>
            <option value="dark">Dark</option>
            <option value="system">System Default</option>
          </select>
        </div>

        <button id="btnSaveSettings" style="width:100%;margin-top:20px;">Save Settings</button>
      </div>

      <!-- CATEGORY MANAGER -->
      <div class="card">
        <strong>Categories</strong>
        <div id="categoryList" style="margin-top:12px;"></div>

        <div class="grid2" style="margin-top:12px;">
          <input id="newCategoryName" placeholder="New Category">
          <button id="btnAddCategory">Add</button>
        </div>
      </div>

      <!-- BUDGET MANAGER -->
      <div class="card">
        <strong>Budgets</strong>
        <div id="budgetList" style="margin-top:10px;"></div>

        <div style="margin-top:16px;">
          <label>Main Category</label>
          <select id="budgetMainCategory"></select>
        </div>

        <div style="margin-top:12px;">
          <label>Amount</label>
          <input type="number" id="budgetAmount">
        </div>

        <div style="margin-top:12px;">
          <label>Period</label>
          <select id="budgetPeriod">
            <option value="weekly">Weekly</option>
            <option value="monthly">Monthly</option>
          </select>
        </div>

        <button id="btnAddBudget" style="margin-top:14px;width:100%;">Add Budget</button>
      </div>
    </div>





    <!-- ===================== ADD TRANSACTION MODAL ===================== -->
    <div id="addModal" style="
         position:fixed; left:0; top:0; right:0; bottom:0;
         background:rgba(0,0,0,0.4);
         display:none;
         justify-content:center;
         align-items:center;
         z-index:2000;">
      <div style="background:white; width:90%; max-width:420px; padding:16px; border-radius:14px;">
        <h3>Add Transaction</h3>

        <label>Type</label>
        <select id="txType">
          <option value="income">Income</option>
          <option value="expense">Expense</option>
        </select>

        <label style="margin-top:10px;">Main Category</label>
        <select id="txMainCategory"></select>

        <label style="margin-top:10px;">Sub Category</label>
        <input type="text" id="txSubCategory" placeholder="Optional">

        <label style="margin-top:10px;">Amount</label>
        <input type="number" id="txAmount">

        <label style="margin-top:10px;">Note</label>
        <input type="text" id="txNote">

        <label style="margin-top:10px;">Date & Time</label>
        <input type="datetime-local" id="txDateTime">

        <div class="grid2" style="margin-top:14px;">
          <button id="btnSaveTx">Save</button>
          <button onclick="closeAddModal()" style="background:#555;">Cancel</button>
        </div>
      </div>
    </div>



    <!-- ===================== EDIT TRANSACTION MODAL ===================== -->
    <div id="editModal" style="
         position:fixed; left:0; top:0; right:0; bottom:0;
         background:rgba(0,0,0,0.4);
         display:none;
         justify-content:center;
         align-items:center;
         z-index:2000;">
      <div style="background:white; width:90%; max-width:420px; padding:16px; border-radius:14px;">
        <h3>Edit Transaction</h3>

        <input type="hidden" id="editTxId">

        <label>Type</label>
        <select id="editTxType">
          <option value="income">Income</option>
          <option value="expense">Expense</option>
        </select>

        <label style="margin-top:10px;">Main Category</label>
        <select id="editTxMainCategory"></select>

        <label style="margin-top:10px;">Sub Category</label>
        <input type="text" id="editTxSubCategory">

        <label style="margin-top:10px;">Amount</label>
        <input type="number" id="editTxAmount">

        <label style="margin-top:10px;">Note</label>
        <input type="text" id="editTxNote">

        <label style="margin-top:10px;">Date & Time</label>
        <input type="datetime-local" id="editTxDateTime">

        <div class="grid2" style="margin-top:14px;">
          <button id="btnUpdateTx">Update</button>
          <button onclick="closeEditModal()" style="background:#555;">Cancel</button>
        </div>
      </div>
    </div>
<script>
// ------------------ Storage & Defaults ------------------
const isoDate = d => (new Date(d)).toISOString().slice(0,10);
const storage = {
  get(k, fallback){ try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : fallback; } catch(e){ return fallback; } },
  set(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
};

const DEFAULT_CATEGORIES = [
  { id:'c-income-salary', name:'Salary', type:'income', sub:['Regular','Bonus'] },
  { id:'c-income-freelance', name:'Freelance', type:'income', sub:['Project','Consult'] },
  { id:'c-exp-food', name:'Food', type:'expense', sub:['Groceries','Dining'] },
  { id:'c-exp-transport', name:'Transport', type:'expense', sub:['Fuel','Taxi'] },
  { id:'c-exp-rent', name:'Rent', type:'expense', sub:['Monthly'] }
];

const DEFAULT_SETTINGS = {
  defaultDashboard: 'today',
  defaultReport: 'month',
  currency: 'USD',
  theme: 'light'
};

let categories = storage.get('sb_categories', DEFAULT_CATEGORIES);
let transactions = storage.get('sb_transactions', []);
let budgets = storage.get('sb_budgets', []);
let settings = storage.get('sb_settings', DEFAULT_SETTINGS);

// ------------------ DOM refs ------------------
const el = id => document.getElementById(id);
const pieCtx = el('pieChart') ? el('pieChart').getContext('2d') : null;
let pieChart = null;

// ------------------ Helpers ------------------
function saveAll(){
  storage.set('sb_categories', categories);
  storage.set('sb_transactions', transactions);
  storage.set('sb_budgets', budgets);
  storage.set('sb_settings', settings);
}

function formatCurrency(v){
  const c = settings.currency || 'USD';
  if(c === 'USD') return '$' + Number(v||0).toFixed(2);
  if(c === 'AED') return 'AED ' + Number(v||0).toFixed(2);
  if(c === 'INR') return '₹' + Number(v||0).toFixed(2);
  if(c === 'NPR') return 'Rs ' + Number(v||0).toFixed(2);
  return (c + ' ' + Number(v||0).toFixed(2));
}

function formatDateTime(iso){
  const d = new Date(iso);
  if(isNaN(d)) return '';
  return d.toLocaleString();
}

function uid(prefix='id'){ return prefix + '-' + Date.now() + '-' + Math.floor(Math.random()*1000); }

// ------------------ Date ranges ------------------
function getRange(period){
  const now = new Date();
  let start = new Date(now), end = new Date(now);
  if(period === 'today'){ start.setHours(0,0,0,0); end.setHours(23,59,59,999); }
  else if(period === 'week'){ start.setDate(now.getDate()-6); start.setHours(0,0,0,0); end.setHours(23,59,59,999); }
  else if(period === 'month'){ start = new Date(now.getFullYear(), now.getMonth(), 1); end = new Date(now.getFullYear(), now.getMonth()+1, 0, 23,59,59,999); }
  else { start = new Date(0); end = new Date(8640000000000000); }
  return { start, end };
}

// ------------------ Rendering: Dashboard ------------------
function renderDashboard(period = settings.defaultDashboard || 'today'){
  const { start, end } = getRange(period);
  el('periodLabel').textContent = period === 'today' ? 'Today' : period === 'week' ? 'Last 7 days' : 'This month';

  const filtered = transactions.filter(t => {
    const d = new Date(t.dateTime);
    return d >= start && d <= end;
  });

  const income = filtered.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const expense = filtered.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);

  el('totalIncome').textContent = formatCurrency(income);
  el('totalExpense').textContent = formatCurrency(expense);
  el('netBalance').textContent = formatCurrency(income - expense);
  el('txCount').textContent = filtered.length;

  // Pie chart
  if(pieCtx){
    const data = [income||1, expense||1];
    if(pieChart) pieChart.destroy();
    pieChart = new Chart(pieCtx, {
      type: 'doughnut',
      data: { labels:['Income','Expenses'], datasets:[{ data, backgroundColor:['#4CAF50','#F44336'] }] },
      options: { plugins:{legend:{position:'bottom'}} }
    });
  }

  // Recent transactions list
  const listEl = el('txList'); listEl.innerHTML = '';
  const rows = filtered.slice().sort((a,b)=>new Date(b.dateTime)-new Date(a.dateTime));
  rows.forEach(tx=>{
    const div = document.createElement('div');
    div.className = 'card';
    div.style.marginBottom = '8px';
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="min-width:0;">
          <div style="font-weight:600">${tx.mainCategory} <span style="color:#777;font-size:13px">(${tx.subCategory||''})</span></div>
          <div style="color:#777;font-size:13px">${formatDateTime(tx.dateTime)} • ${tx.note||''}</div>
        </div>
        <div style="text-align:right;">
          <div style="font-weight:700;color:${tx.type==='income'?'#4CAF50':'#F44336'}">${formatCurrency(tx.amount)}</div>
          <div style="color:#777;font-size:12px">${tx.type.toUpperCase()}</div>
          <div style="margin-top:6px;">
            <button class="btn" data-action="edit" data-id="${tx.id}" style="margin-right:6px;background:#1976d2;">Edit</button>
            <button class="btn" data-action="delete" data-id="${tx.id}" style="background:#d32f2f;">Del</button>
          </div>
        </div>
      </div>
    `;
    listEl.appendChild(div);
  });

  renderBudgets({ start, end });
}

// ------------------ Rendering: Transactions Table (Report) ------------------
function renderReportList(filtered){
  const container = el('reportList'); container.innerHTML = '';
  if(!filtered || !filtered.length){ container.innerHTML = '<div style="color:#777">No transactions</div>'; return; }
  filtered.slice().sort((a,b)=>new Date(b.dateTime)-new Date(a.dateTime)).forEach(t=>{
    const d = document.createElement('div');
    d.style.display = 'flex';
    d.style.justifyContent = 'space-between';
    d.style.padding = '8px 0';
    d.innerHTML = `<div><strong>${t.mainCategory} - ${t.subCategory||''}</strong><div style="font-size:13px;color:#666">${formatDateTime(t.dateTime)}</div><div style="font-size:13px;color:#666">${t.note||''}</div></div><div style="text-align:right">${formatCurrency(t.amount)}<div style="font-size:12px;color:#777">${t.type.toUpperCase()}</div></div>`;
    container.appendChild(d);
  });
}

// ------------------ Budgets ------------------
function renderBudgets(range){
  const container = el('budgetCards'); container.innerHTML = '';
  budgets.forEach(b=>{
    const start = new Date(b.startDate), end = new Date(b.endDate);
    const actual = transactions.filter(t=>{
      const d = new Date(t.dateTime);
      if(d < start || d > end) return false;
      return b.categories && b.categories.length ? b.categories.includes(t.mainCategory) : true;
    }).filter(t=>t.type === b.type).reduce((s,t)=>s+t.amount,0);

    const percent = Math.round((actual / (b.amount || 1))*100);
    const rem = b.amount - actual;
    const div = document.createElement('div'); div.className='card';
    div.innerHTML = `<div style="display:flex;justify-content:space-between;"><div><strong>${b.name|| (b.type==='expense'?'Expense':'Income')}</strong><div style="font-size:13px;color:#777">${b.categories?b.categories.join(', '):'All'}</div></div><div style="text-align:right"><div style="font-weight:700">${formatCurrency(b.amount)}</div></div></div><div style="margin-top:8px;"><div style="height:10px;background:#eee;border-radius:8px;overflow:hidden;"><div style="width:${Math.min(percent,100)}%;height:100%;background:${b.type==='income'?'#4CAF50':'#F44336'}"></div></div><div style="font-size:13px;color:#777;margin-top:6px;">${percent}% • Remaining ${formatCurrency(rem)}</div></div>`;
    container.appendChild(div);
  });
}

// ------------------ Categories UI ------------------
function populateCategorySelects(){
  const selAdd = el('txMainCategory'); selAdd.innerHTML = '';
  const selEdit = el('editTxMainCategory'); if(selEdit) selEdit.innerHTML = '';
  const selBudget = el('budgetMainCategory'); if(selBudget) selBudget.innerHTML = '';
  categories.forEach(c=>{
    const opt = document.createElement('option'); opt.value = c.name; opt.textContent = c.name;
    if(selAdd) selAdd.appendChild(opt.cloneNode(true));
    if(selEdit) selEdit.appendChild(opt.cloneNode(true));
    if(selBudget) selBudget.appendChild(opt.cloneNode(true));
  });
  // category list in settings
  const catList = el('categoryList'); if(catList){
    catList.innerHTML = '';
    categories.forEach(c=>{
      const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.padding='6px 0';
      row.innerHTML = `<div><strong>${c.name}</strong><div style="font-size:13px;color:#666">${(c.sub||[]).join(', ')}</div></div><div><button data-id="${c.id}" data-action="delCat" class="btn" style="background:#d32f2f;">Delete</button></div>`;
      catList.appendChild(row);
    });
  }
}

// ------------------ Add / Edit / Delete Transactions (core) ------------------
function addTransaction(tx){
  tx.id = uid('tx');
  transactions.push(tx);
  saveAll();
  renderDashboard(settings.defaultDashboard || 'today');
}

function updateTransaction(id, payload){
  transactions = transactions.map(t => t.id === id ? Object.assign({}, t, payload) : t);
  saveAll();
  renderDashboard(settings.defaultDashboard || 'today');
}

function removeTransaction(id){
  if(!confirm('Delete transaction?')) return;
  transactions = transactions.filter(t=>t.id !== id);
  saveAll();
  renderDashboard(settings.defaultDashboard || 'today');
}

// ------------------ Reports generation ------------------
function generateReport(from, to, type='all'){
  const f = from ? new Date(from) : new Date(0);
  const t = to ? new Date(to + 'T23:59:59') : new Date();
  const filtered = transactions.filter(tx => {
    const d = new Date(tx.dateTime);
    if(d < f || d > t) return false;
    if(type !== 'all' && tx.type !== type) return false;
    return true;
  });
  const income = filtered.filter(x=>x.type==='income').reduce((s,x)=>s+x.amount,0);
  const expense = filtered.filter(x=>x.type==='expense').reduce((s,x)=>s+x.amount,0);
  el('reportSummary').innerHTML = `<div>Total Income: <strong>${formatCurrency(income)}</strong></div><div>Total Expense: <strong>${formatCurrency(expense)}</strong></div><div>Net: <strong>${formatCurrency(income-expense)}</strong></div>`;
  el('reportResults').style.display = 'block';
  renderReportList(filtered);
  return { filtered, income, expense, from:f, to:t };
}

// ------------------ Init ------------------
function initCore(){
  populateCategorySelects();
  renderDashboard(settings.defaultDashboard || 'today');

  // populate default report dates
  const today = new Date();
  el('reportTo').value = isoDate(today);
  const wk = new Date(); wk.setDate(today.getDate()-6);
  el('reportFrom').value = isoDate(wk);
}

// Run init
document.addEventListener('DOMContentLoaded', initCore);
</script>
<script>
// ------------------ EVENT HANDLERS ------------------

// Bottom Navigation
document.getElementById("bottomNav").addEventListener("click", e=>{
  const btn = e.target.closest("button");
  if(!btn) return;
  document.querySelectorAll("#bottomNav button").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  showView(btn.dataset.view);
});

function showView(name){
  document.getElementById("dashboardView").style.display = name==="dashboard" ? "" : "none";
  document.getElementById("reportsView").style.display   = name==="reports"   ? "" : "none";
  document.getElementById("settingsView").style.display  = name==="settings"  ? "" : "none";

  if(name==="dashboard") renderDashboard(settings.defaultDashboard || "today");
  if(name==="reports")   generateReport(el("reportFrom").value, el("reportTo").value, el("reportType").value);
  if(name==="settings")  populateCategorySelects();
}


// ------------------ ADD TRANSACTION MODAL ------------------
const addModal = document.getElementById("addTransactionModal");

document.getElementById("addTxBtn").addEventListener("click", ()=>{
  addModal.style.display="block";
  loadAddModalDefaults();
});

document.getElementById("closeAddTx").addEventListener("click", ()=>{
  addModal.style.display="none";
});

function loadAddModalDefaults(){
  const now = new Date();
  el("txDate").value = isoDate(now);
  el("txTime").value = now.toTimeString().slice(0,5);
  el("txAmount").value = "";
  el("txNote").value = "";
}


// ------------------ SAVE NEW TRANSACTION ------------------
document.getElementById("saveTransaction").addEventListener("click", ()=>{
  const amount = parseFloat(el("txAmount").value);
  const type   = el("txType").value;
  const main   = el("txMainCategory").value;
  const sub    = el("txSubCategory").value;
  const note   = el("txNote").value;
  const date   = el("txDate").value;
  const time   = el("txTime").value;

  if(!amount || amount<=0){ alert("Enter valid amount."); return; }
  if(!main){ alert("Choose category"); return; }

  const dt = new Date(date+"T"+time+":00");

  addTransaction({
    id: uid("tx"),
    amount,
    type,
    mainCategory: main,
    subCategory: sub,
    note,
    dateTime: dt.toISOString()
  });

  addModal.style.display="none";
});


// ------------------ EDIT TRANSACTION MODAL ------------------
const editModal = document.getElementById("editTransactionModal");
let editingId = null;

document.body.addEventListener("click", e=>{
  if(e.target.dataset.action === "edit"){
    const id = e.target.dataset.id;
    const tx = transactions.find(t=>t.id===id);
    if(!tx) return;

    editingId = id;
    el("editTxAmount").value = tx.amount;
    el("editTxType").value = tx.type;
    el("editTxMainCategory").value = tx.mainCategory;
    el("editTxSubCategory").value = tx.subCategory;
    el("editTxNote").value = tx.note;

    const dt = new Date(tx.dateTime);
    el("editTxDate").value = isoDate(dt);
    el("editTxTime").value = dt.toTimeString().slice(0,5);

    editModal.style.display="block";
  }
});

document.getElementById("closeEditTx").addEventListener("click", ()=>{
  editModal.style.display="none";
});

document.getElementById("updateTransaction").addEventListener("click", ()=>{
  if(!editingId) return;

  updateTransaction(editingId, {
    amount: parseFloat(el("editTxAmount").value),
    type: el("editTxType").value,
    mainCategory: el("editTxMainCategory").value,
    subCategory: el("editTxSubCategory").value,
    note: el("editTxNote").value,
    dateTime: new Date(el("editTxDate").value+"T"+el("editTxTime").value+":00").toISOString()
  });

  editModal.style.display="none";
});


// ------------------ DELETE TRANSACTION ------------------
document.body.addEventListener("click", e=>{
  if(e.target.dataset.action === "delete"){
    removeTransaction(e.target.dataset.id);
  }
});


// ------------------ SETTINGS: ADD CATEGORY ------------------
document.getElementById("addCategory").addEventListener("click", ()=>{
  const name = el("newCategoryName").value.trim();
  const type = el("newCategoryType").value;
  const subs = el("newCategorySubs").value.split(",").map(s=>s.trim()).filter(Boolean);

  if(!name){ alert("Enter name"); return; }

  categories.push({
    id: uid("cat"),
    name,
    type,
    sub: subs
  });

  saveAll();
  populateCategorySelects();

  el("newCategoryName").value = "";
  el("newCategorySubs").value = "";
});


// DELETE CATEGORY
document.getElementById("categoryList").addEventListener("click", e=>{
  if(e.target.dataset.action === "delCat"){
    const id = e.target.dataset.id;
    categories = categories.filter(c=>c.id!==id);
    saveAll();
    populateCategorySelects();
  }
});


// ------------------ ADD BUDGET ------------------
document.getElementById("addBudget").addEventListener("click", ()=>{
  const name = el("budgetName").value;
  const main = el("budgetMainCategory").value;
  const amount = parseFloat(el("budgetAmount").value);
  const start  = el("budgetStart").value;
  const end    = el("budgetEnd").value;
  const type   = el("budgetType").value;

  if(!amount || !start || !end){
    alert("Enter all fields");
    return;
  }

  budgets.push({
    id: uid("budget"),
    name,
    categories: main ? [main] : [],
    amount,
    startDate: start,
    endDate: end,
    type
  });

  saveAll();
  renderBudgets();
});


// ------------------ REPORT FILTER ------------------
document.getElementById("applyReport").addEventListener("click", ()=>{
  generateReport(el("reportFrom").value, el("reportTo").value, el("reportType").value);
});


// ------------------ EXPORT EXCEL ------------------
document.getElementById("exportExcel").addEventListener("click", ()=>{
  const data = generateReport(el("reportFrom").value, el("reportTo").value, el("reportType").value);

  const wb = XLSX.utils.book_new();
  const rows = [
    ["Date","Type","Category","Subcategory","Amount","Note"]
  ];

  data.filtered.forEach(t=>{
    rows.push([
      formatDateTime(t.dateTime),
      t.type,
      t.mainCategory,
      t.subCategory,
      t.amount,
      t.note || ""
    ]);
  });

  const ws = XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, "Report");
  XLSX.writeFile(wb, "SmartBudget-Report.xlsx");
});


// ------------------ EXPORT PDF (FIXED VERSION) ------------------
document.getElementById("exportPDF").addEventListener("click", ()=>{
  const data = generateReport(el("reportFrom").value, el("reportTo").value, el("reportType").value);

  const pdf = new jspdf.jsPDF({ unit:"pt", format:"a4" });

  pdf.setFontSize(18);
  pdf.text("SmartBudget Report", 40, 40);

  pdf.setFontSize(12);
  pdf.text("From: " + isoDate(data.from), 40, 70);
  pdf.text("To: " + isoDate(data.to), 40, 90);

  let y = 130;

  data.filtered.forEach(t=>{
    pdf.text(formatDateTime(t.dateTime), 40, y);
    pdf.text(t.type.toUpperCase(), 160, y);
    pdf.text(t.mainCategory + " - " + (t.subCategory||""), 240, y);
    pdf.text(formatCurrency(t.amount), 430, y);
    y += 20;
    if(y > 760){ pdf.addPage(); y = 40; }
  });

  pdf.save("SmartBudget-Report.pdf");
});


// ------------------ SERVICE WORKER ------------------
if('serviceWorker' in navigator){
  navigator.serviceWorker.register("service-worker.js").catch(()=>{});
}

</script>
...
<!-- END OF PART 3 CODE -->


<!-- BEGIN PART 4 -->
<script>
// all PART 4 code here
</script>
<!-- END PART 4 -->

</body>
</html>




